{% extends "base.html" %}
{% block content %}

<div class="container">
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <h1 style="margin-bottom:1rem;">ë‚´ ìºë¦­í„°</h1>

    {# ğŸ” ê²€ìƒ‰ + ì •ë ¬ ë°” #}
    <form method="get" style="margin-bottom:1rem; display:flex; gap:.5rem; flex-wrap:wrap;">
      <input type="text" name="search" value="{{ request.GET.search|default:'' }}" placeholder="ê²€ìƒ‰"
             style="flex:1; padding:.5rem 1rem; border:1px solid #e5e7eb; border-radius:.5rem;">
      
      <select name="sort" style="padding:.5rem 1rem; border:1px solid #e5e7eb; border-radius:.5rem;">
        <option value="">ì •ë ¬ ì—†ìŒ</option>
        <option value="rating" {% if request.GET.sort == 'rating' %}selected{% endif %}>í‰ì ìˆœ</option>
        <option value="created" {% if request.GET.sort == 'created' %}selected{% endif %}>ìƒì„±ì¼ìˆœ</option>
      </select>

      <button type="submit"
              style="padding:.5rem 1rem; border-radius:.5rem; background:#6366f1; color:#fff; border:none;">
        í•„í„°
      </button>
    </form>

    {% if page_obj.object_list %}
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;">
      {% for ch in page_obj.object_list %}
      <div style="border:1px solid #e5e7eb;border-radius:.75rem;padding:1rem;background:#fff;text-align:center;">

        {# ìºë¦­í„° ì´ë¯¸ì§€ #}
        {% if ch.character_image %}
          <a href="{% url 'characters:character_detail' ch.id %}">
            <img src="{{ ch.character_image.url }}" alt="{{ ch.name }}"
                 style="width:100px;height:100px;object-fit:cover;margin:0 auto .75rem;display:block;border-radius:50%;">
          </a>
        {% else %}
          <div style="width:100px;height:100px;border-radius:50%;background:#f3f4f6;display:flex;align-items:center;justify-content:center;margin:0 auto .75rem;">
            <span style="font-size:2rem;color:#9ca3af;">?</span>
          </div>
        {% endif %}

        {# ìºë¦­í„° ì´ë¦„ #}
        <h3 style="margin:0 0 .35rem 0;font-size:1.1rem;font-weight:600;">
          <a href="{% url 'characters:character_detail' ch.id %}" style="color:#111827;text-decoration:none;">
            {{ ch.name }}
          </a>
        </h3>

        {# ì¥ë¥´ + ê³µê°œ ë²”ìœ„ #}
        <div style="margin-bottom:.6rem; font-size:.85rem; color:#6b7280;">
          <span style="display:inline-block;padding:.25rem .6rem;border-radius:9999px;background:#f3f4f6;color:#4b5563;font-size:.8rem;">
            {{ ch.genre.name }}
          </span>
          Â·
          {% if ch.visibility == "public" %}
            <span style="color:#2563eb;font-weight:500;">ê³µê°œ</span>
          {% else %}
            <span style="color:#dc2626;font-weight:500;">ë¹„ê³µê°œ</span>
          {% endif %}
        </div>

        {# êµ¬ë¶„ì„  #}
        <div style="height:1px;background:#e5e7eb;margin:.7rem 0 .8rem;"></div>

        {# í•œì¤„ ì†Œê°œ (20ì ì œí•œ, ì™¼ìª½ ì •ë ¬) #}
        <p style="margin:0 0 .6rem 0;color:#374151;font-size:.9rem;text-align:left;padding-left:.35rem;">
          {% if ch.description|length > 20 %}
            {{ ch.description|slice:":20" }}...
          {% else %}
            {{ ch.description }}
          {% endif %}
        </p>

        {# í‰ê·  í‰ì  & ìƒì„±ì¼ #}
        <div style="font-size:.85rem; color:#6b7280; text-align:left; padding-left:.35rem; margin-bottom:.6rem;">
          í‰ê·  í‰ì : {{ ch.average_rating }} ({{ ch.rating_count }}ëª…)<br>
          ìƒì„±ì¼: {{ ch.created_at|date:"Y-m-d" }}
        </div>

        {# ê´€ë¦¬ ë²„íŠ¼ #}
        <div style="margin-top:.8rem; display:flex; gap:.5rem; justify-content:center;">
          <a href="{% url 'characters:character_edit' ch.id %}"
             style="padding:.4rem .8rem; border:1px solid #d1d5db; border-radius:.5rem; text-decoration:none; color:#374151; font-size:.85rem;">
            ìˆ˜ì •
          </a>
          <a href="{% url 'characters:character_delete' ch.id %}"
             style="padding:.4rem .8rem; border:1px solid #ef4444; background:#ef4444; border-radius:.5rem; text-decoration:none; color:white; font-size:.85rem;">
            ì‚­ì œ
          </a>
        </div>
      </div>
      {% endfor %}
    </div>

    {# í˜ì´ì§€ë„¤ì´ì…˜ #}
    <div style="margin-top:1.5rem; display:flex; gap:.5rem; justify-content:center; align-items:center;">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&search={{ request.GET.search }}&sort={{ request.GET.sort }}"
           style="padding:.4rem .8rem; border:1px solid #e5e7eb; border-radius:.5rem; text-decoration:none; color:#374151;">ì´ì „</a>
      {% endif %}
      <span style="color:#6b7280;">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&search={{ request.GET.search }}&sort={{ request.GET.sort }}"
           style="padding:.4rem .8rem; border:1px solid #e5e7eb; border-radius:.5rem; text-decoration:none; color:#374151;">ë‹¤ìŒ</a>
      {% endif %}
    </div>

    {% else %}
    <p>ì•„ì§ ë§Œë“  ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤. <a href="{% url 'characters:character_create' %}" style="color:#6366f1;">ìºë¦­í„° ë§Œë“¤ê¸°</a></p>
    {% endif %}
</div>

{% endblock %}